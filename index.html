<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Navon Task - jsPsych</title>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" type="text/css">
  <style>
    body {
      background-color: black;
      color: white;
      font-family: monospace;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .navon-letter {
      font-size: 28px;
      color: white;
      font-family: monospace;
      display: inline-block;
      width: 28px;
      height: 28px;
      text-align: center;
    }
  </style>
</head>
<body>

<script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>

<script>
const N_TRIALS_GLOBAL = 20;
const N_TRIALS_LOCAL  = 20;
const N_TRIALS_MIXED  = 40;
const GLOBAL_LETTERS = ["H", "S"];
const GRID_SIZE = 9;

const TEMPLATES = {
  "H":[
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1]
  ],
  "S":[
    [0,1,1,1,1,1,1,1,0],
    [1,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0],
    [0,1,0,0,0,0,0,0,0],
    [0,0,1,1,1,1,1,0,0],
    [0,0,0,0,0,0,0,1,0],
    [0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,1],
    [0,1,1,1,1,1,1,1,0]
  ]
};

function generateNavonHTML(global_letter, local_letter){
  let html = '<div style="display:inline-block;">';
  const template = TEMPLATES[global_letter];
  for(let r=0; r<GRID_SIZE; r++){
    html += '<div>';
    for(let c=0; c<GRID_SIZE; c++){
      html += template[r][c] === 1 
              ? `<span class="navon-letter">${local_letter}</span>` 
              : `<span class="navon-letter">&nbsp;</span>`;
    }
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function createTrials(block_type, n_trials, fixed_task=null){
  const trials = [];
  for(let i=0;i<n_trials;i++){
    let task = fixed_task || (block_type==="mixed" ? (Math.random()<0.5?"global":"local") : fixed_task);
    let condition = Math.random()<0.5 ? "congruent" : "incongruent";
    let global_letter, local_letter;

    if(condition==="congruent"){
      global_letter = local_letter = GLOBAL_LETTERS[Math.floor(Math.random()*2)];
    } else {
      const shuffled = [...GLOBAL_LETTERS].sort(()=>Math.random()-0.5);
      global_letter = shuffled[0];
      local_letter  = shuffled[1];
    }

    if(block_type==="mixed"){
      const cue = task==="global" ? "↑" : "↓";
      trials.push({
        type: "html-keyboard-response",
        stimulus: `<div style="font-size:80px; color:yellow;">${cue}</div>`,
        choices: jsPsych.NO_KEYS,
        trial_duration: 700,
        data: {ignore:true}
      });
    }

    trials.push({
      type: "html-keyboard-response",
      stimulus: generateNavonHTML(global_letter, local_letter),
      choices: ["1","2"],
      trial_duration: 1500,
      data: {
        block: block_type,
        trial: i+1,
        condition: condition,
        task: task,
        global_letter: global_letter,
        local_letter: local_letter
      },
      on_finish: function(data){
        const correct = (data.task==="global" && data.global_letter==="H") || 
                        (data.task==="local" && data.local_letter==="H") ? "1" : "2";
        data.correct = (data.response===correct)?1:0;
      }
    });
  }
  return trials;
}

let timeline = [];

timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h2>Neivona uzdevums</h2>
    <p>Vēro burtus, kas parādīsies uz ekrāna.</p>
    <p>Atbildi: "H" = 1, "S" = 2</p>
    <p>Atbildes jāsniedz ātri, jo limits ir 1,5 sekundes.</p>
    <p>Nospied SPACE, lai sāktu eksperimentu.</p>
  `,
  choices: [" "],
  data: {ignore:true}
});

timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h2>Globālais bloks</h2>
    <p>Fokusējies uz LIELAJIEM burtiem.</p>
    <p>Ignorē mazos burtiņus.</p>
    <p>H = 1, S = 2</p>
    <p>Nospied SPACE, lai sāktu.</p>
  `,
  choices: [" "],
  data: {ignore:true}
});
timeline.push(...createTrials("global", N_TRIALS_GLOBAL, "global"));

timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h2>Lokālais bloks</h2>
    <p>Fokusējies uz MAZAJIEM burtiem.</p>
    <p>Ignorē lielos burtiņus.</p>
    <p>H = 1, S = 2</p>
    <p>Nospied SPACE, lai sāktu.</p>
  `,
  choices: [" "],
  data: {ignore:true}
});
timeline.push(...createTrials("local", N_TRIALS_LOCAL, "local"));

timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h2>Mix bloks</h2>
    <p>Pirms katra uzdevuma ir bultiņa:</p>
    <p>↑ - fokusējies uz globālo (lielo) burtu</p>
    <p>↓ - fokusējies uz lokālo (mazo) burtu</p>
    <p>H = 1, S = 2</p>
    <p>Nospied SPACE, lai sāktu.</p>
  `,
  choices: [" "],
  data: {ignore:true}
});
timeline.push(...createTrials("mixed", N_TRIALS_MIXED));

timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h2>Paldies par dalību!</h2>
  `,
  choices: jsPsych.NO_KEYS,
  trial_duration: 10000,
  data: {ignore:true}
});

jsPsych.init({
  timeline: timeline,
  on_finish: function(){

    const columns = ["block","trial","condition","global_letter","local_letter","task","response","correct","rt"];

    let data = jsPsych.data.get().filterCustom(d => d.trial_type==="html-keyboard-response" && !d.ignore);

    let csv = columns.join(",") + "\n";
    data.values().forEach(row => {
      let line = columns.map(col =>
      col === "rt"
      ? (row[col] !== null ? Math.round(row[col]) : "")
      : row[col]
        ).join(",");
      csv += line + "\n";
    });

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "navon_data.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
});
</script>

</body>
</html>
